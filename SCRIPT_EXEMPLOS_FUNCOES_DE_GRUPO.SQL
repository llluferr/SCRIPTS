-- FUNÇÕES DE GRUPO E AGRUPAMENTOS
-- ENVOLVEM A RECUPERAÇÃO DE UM CONJUNTO (GRRUPO) DE LINHAS
-- OU ATE A TABELA INTEIRA, COM OBJETIVO DE DAR ALGUM TIPO DE RESULTADO
 
-- FUNÇÕES DE GRUPO - ATUANDO A PARTIR DE TODAS AS LINHAS DA TABELA
-- EXEMPLO: CONTAGEM, SOMATORIA, MEDIA, VALOR MAXIMO, VALOR MINIMO, DESVIO PADRAO, VARIANCIA

-- COUNT() - CONTAGEM
-- RECUPERAR A QTDE DE DEPARTAMENTOS
SELECT COUNT(*) AS "QTDE DE DEPTOS: "
  FROM T_SIP_DEPARTAMENTO; 
-- CONTAGEM BASEADA EM TODAS AS COLUNAS DA TABELA

-- COUNT() - APONTANDO PARA UMA COLUNA ESPECIFICA
-- RECUPERANDO A QTDE DE PROJETOS FINALIZADOS
SELECT COUNT(DT_TERMINO) AS "QTDE PROJETOS FINALIZADOS: "
  FROM T_SIP_PROJETO;
-- CONTAGEM BASEADA APENAS NA COLUNA INFORMADA

-- COUNT() - COM CONDIÇÃO NA CLAUSULA WHERE
-- RECUPERANDO A QTDE DE PROJETOS NAO FINALIZADOS
SELECT COUNT(CD_PROJETO) -- CONTAGEM A PARTIR DE UMA COLUNA ESPECIFICA (PK)
  FROM T_SIP_PROJETO
 WHERE DT_TERMINO IS NULL; -- VALIDANDO PROJETOS NAO FINALIZADOS

-- COUNT() E DISTINCT
 --  QTDE TOTAL DE IMPLANTACOES
SELECT COUNT(CD_PROJETO) AS "QNTD DE IMPLANTACOES: "
  FROM T_SIP_IMPLANTACAO;
 
-- RECUPERAR A QTDE DE PROJETOS EM IMPLANTACAO
SELECT DISTINCT COUNT(CD_PROJETO) AS "QNTD DE PROJETOS EM IMPLANTACAO: " 
  FROM T_SIP_IMPLANTACAO;

-- RECUPERAR A QTDE IMPLANTACÕES QUE FORAM FINALIZADAS
SELECT COUNT(DT_SAIDA) AS "QNTD DE IMPLANTACOES FINALIZADAS: "
  FROM T_SIP_IMPLANTACAO;
-- IMPLANTACOES FINALIZADAS
-- IMPLANTACAO FINALIZADA POSSUI DATA DA SAIDA PREENCHIDA

-- QUANTOS PROJETOS POSSUEM IMPLANTACOES FINALIZADAS
SELECT COUNT(DISTINCT CD_PROJETO) AS "PROJETOS COM IMPLANTACOES FINALIZADAS: "
  FROM T_SIP_IMPLANTACAO 
 WHERE DT_SAIDA IS NOT NULL;

 -- SUM() - SOMATORIA
-- RECUPERAR A SOMATORIA DE SALARIOS (DE TODA EMPRESA)
SELECT SUM(VL_SALARIO_MENSAL)
  FROM T_SIP_FUNCIONARIO;  

-- AVG() - MEDIA
-- RECUPERAR A MEDIA DOS SALARIOS DE TODA EMPRESA
SELECT AVG(VL_SALARIO_MENSAL)
  FROM T_SIP_FUNCIONARIO;

SELECT ROUND(AVG(VL_SALARIO_MENSAL, 2))
  FROM T_SIP_FUNCIONARIO;

-- ASSOCIANDO...SEM USAR AVG() -- SOMATORIA/QTDE
SELECT ROUND(SUM(VL_SALARIO_MENSAL) / COUNT(NR_MATRICULA), 2)

-- MIN() - MENOR VALOR
-- RECUPERAR O MENOR SALARIO DE TODA EMPRESA
SELECT MIN(VL_SALARIO_MENSAL)
  FROM T_SIP_FUNCIONARIO;

-- MAX() - MAIOR VALOR  
-- RECUPERAR O MAIOR SALARIO DE TODA EMPRESA
SELECT MAX(VL_SALARIO_MENSAL)
  FROM T_SIP_FUNCIONARIO;

-- AGRUPAMENTOS
-- CRIANDO GRUPOS DE DADOS
-- RECUPERAR A QTDE DE DEPENDENTES DE CADA FUNCIONARIO
SELECT NR_MATRICULA, COUNT(CD_DEPENDENTE) AS "QNTD DEPENDENTES: "
  FROM T_SIP_DEPENDENTE
GROUP BY NR_MATRICULA;

-- SO E POSSIVEL VISUALIZAR O QUE FIZER PARTE DO GRUPO
-- ALEM DOS DADOS QUE FIZEREM PARTE DO GRUPO, SÓ E POSSIVEL
-- EXIBIR O RESULTADO DE UMA FUNÇÃO DE GRUPO (COUNT,SUM, AVG, MIN, MAX..

-- CRIANDO GRUPOS DE DADOS
-- RECUPERAR A MEDIA SALARIAL POR DEPTO
-- AGRUPAR POR DEPTO E APLICAR A MEDIA POR DEPTO
SELECT CD_DEPTO, AVG(COUNT(VL_SALARIO_MENSAL, 2)) AS "MEDIA SALARIAL DO DEPTO: "
  FROM T_SIP_FUNCIONARIO
GROUP BY CD_DEPTO;

-- INSERINDO FILTRO DE TABELA COM WHERE
-- AGRUPAR APENAS OS DEPTOS DE CODIGO 1, 4 E 5
-- FAREMOS UM FILTRO ANTES DE AGRUPAR
SELECT CD_DEPTO,
        COUNT(NR_MATRICULA) AS "QNTD FUNCIONARIOS POR DEPTO: ",
        SUM(VL_SALARIO_MENSAL) AS "TOTAL DE SALARIOS POR DEPTO",
        ROUND(AVG(VL_SALARIO_MENSAL),2) AS "MEDIA DE SALARIOS POR DEPTO: "
  FROM T_SIP_FUNCIONARIO
 WHERE CD_DEPTO IN (1,4,5)
 GROUP BY CD_DEPTO
 ORDER BY "MEDIA DE SALARIOS POR DEPTO" DESC;

-- INSERINDO FILTRO DE GRUPO COM HAVING
-- DEPOIS QUE OS GRUPOS FOREM MONTADOS IREMOS RECUPERAR APENAS OS
-- GRUPOS QUE TIVEREM TOTAL DE SALARIO SUPERIOR A 10000,00
SELECT CD_DEPTO,
        COUNT(NR_MATRICULA) AS "QNTD FUNCIONARIOS POR DEPTO: ",
        SUM(VL_SALARIO_MENSAL) AS "TOTAL DE SALARIOS POR DEPTO",
        ROUND(AVG(VL_SALARIO_MENSAL),2) AS "MEDIA DE SALARIOS POR DEPTO: "
  FROM T_SIP_FUNCIONARIO
 WHERE CD_DEPTO IN (1,4,5)
 GROUP BY CD_DEPTO
   HAVING SUM(VL_SALARIO_MENSAL) > 10000 
 ORDER BY "MEDIA DE SALARIOS POR DEPTO" DESC;

-- CRIANDO GRUPOS E JUNTANDO TABELAS
-- RECUPERAR A MEDIA SALARIAL POR DEPTO, EXIBINDO O NOME DO DEPTO
SELECT F.CD_DEPTO,
        ROUND(AVG(F.VL_SALARIO_MENSAL),2) "MEDIA SALARIAL"
    FROM T_SIP_DEPARTAMENTO D INNER JOIN T_SIP_FUNCIONARIO F
            ON (D.CD_DEPTO = F.DEPTO) --PK = FK
GROUP BY F.CD_DEPTO, D.NM_DEPTO;

--INSERINDO WHERE E HAVING
SELECT F.CD_DEPTO, D.NM_DEPTO,
        COUNT(F.NR_MATRICULA) AS "QNTD FUNCIONARIOS POR DEPTO: ",
        SUM(F.VL_SALARIO_MENSAL) AS "TOTAL DE SALARIOS POR DEPTO",
        ROUND(AVG(F.VL_SALARIO_MENSAL),2) AS "MEDIA DE SALARIOS POR DEPTO: "
  FROM T_SIP_DEPARTAMENTO D INNER JOIN T_SIP_FUNCIONARIO F
            ON (D.CD_DEPTO = F.DEPTO) --PK = FK
 WHERE F.CD_DEPTO IN (1,4,5)
 GROUP BY F.CD_DEPTO, D.NM_DEPTO
   HAVING SUM(F.VL_SALARIO_MENSAL) > 10000 
 ORDER BY "MEDIA DE SALARIOS POR DEPTO" DESC;